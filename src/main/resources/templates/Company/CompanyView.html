<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="junlazy"/>
    <meta name="description" content="inputBoot index"/>
    <title>기업 상세보기 페이지</title>
</head>
<link rel="stylesheet" type="text/css" href="css/style.css">
<body>
<table>
    <caption>기업 상세보기</caption>
    <tr>
        <th>기업 코드</th>
        <td th:text="${view.companyCode}"></td>
    </tr>
    <tr>
        <th>기업 아이디</th>
        <td th:text="${view.companyId}"></td>
    </tr>
    <tr>
        <th>기업 상세설명</th>
        <td th:text="${view.companyComment}"></td>
    </tr>
    <tr>
        <th>기업 사진</th>
        <td><img th:src="@{/CompanyPhoto/{photo}(photo=${view.companyPhotoName})}" style="width:200px;"/></td>
    </tr>
    <tr>
        <th>기업 평점</th>
        <td th:text="${view.companyRate}"></td>
    </tr>
    <tr>
        <th>기업 시설</th>
        <td th:text="${view.companyEquipment}"></td>
    </tr>
    <tr>
        <th>리뷰 등록</th>
        <td><textarea rows=1 cols=70 id="reviewContent" placeholder="리뷰를 작성해주세요."></textarea>
            <button id="commentBtn">리뷰 등록</button>
        </td>
    </tr>
</table>
<span>별점 선택</span>
<input type="radio" name="reviewRate" value="1" id="rate1"><label
        for="rate1">★</label>
<input type="radio" name="reviewRate" value="2" id="rate2"><label
        for="rate2">★★</label>
<input type="radio" name="reviewRate" value="3" id="rate3"><label
        for="rate3">★★★</label>
<input type="radio" name="reviewRate" value="4" id="rate4"><label
        for="rate4">★★★★</label>
<input type="radio" name="reviewRate" value="5" id="rate5" checked><label
        for="rate5">★★★★★</label>
<input type="hidden" th:id="memberId" th:value="${session.login.memberId}">
<input type="hidden" th:id="companyCode" th:value="${view.companyCode}">
<div id="commentArea"></div>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script th:inline="javascript">
    var companyCode = [[${view.companyCode}]];
    $(document).ready(function () {


    });

    // 리뷰 목록

    console.log(companyCode);

    $.ajax({
        type: "POST",
        url: "comment/commentList",
        data: {"companyCode": companyCode},
        dataType: "json",
        success: function (list) {
            commentList(list);
        },
        error: function (request, status, error) {
            alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
        }
    });

    // 버튼 클릭 시
    $('#commentBtn').click(function () {
        var loginId = $("#memberId").val();
        console.log('아이디 : ' + loginId);
        if (!loginId) {
            alert('로그인 이후 사용할 수 있습니다.');
            location.href = "index";
        } else {
            var reviewWriter = loginId;
            var companyCode = document.getElementById("companyCode").value;
            var reviewContent = $('#reviewContent').val();
            var reviewRate = $('input[name="reviewRate"]:checked').val();

            $.ajax({
                type: "POST",
                url: "comment/commentRegist",
                data: {
                    "reviewWriter": reviewWriter,
                    "companyCode": companyCode,
                    "reviewContent": reviewContent,
                    "reviewRate": reviewRate
                },
                dataType: "json",
                success: function (list) {
                    commentList(list);
                    $('#reviewContent').val("");
                    reload();
                },
                error: function () {
                    alert('리뷰 등록 실패');
                }
            });
        }
    });

    // 리뷰 삭제
    function commentDelete(reviewNo, companyCode) {
        var check = confirm('리뷰를 삭제하시겠습니까?');
        var companyCode = [[${view.companyCode}]];

        if (check) {
            $.ajax({
                type: "POST",
                url: "comment/commentDelete",
                data: {"reviewNo": reviewNo, "companyCode": companyCode},
                dataType: "json",
                success: function (list) {
                    commentList(list);
                    reload();
                },
                error: function () {
                    alert('리뷰 삭제 실패');
                }
            });
        }
    }

    // 리뷰 수정
    function commentModify(reviewNo, companyCode) {
        var check = confirm('리뷰를 수정하시겠습니까?');
        var reviewContent = $('#reviewContent').val();
        var companyCode = [[${view.companyCode}]];
        var reviewRate = $('input[name="reviewRate"]:checked').val();

        if (check) {
            $.ajax({
                type: "POST",
                url: "comment/commentModify",
                data: {
                    "reviewNo": reviewNo,
                    "companyCode": companyCode,
                    "reviewContent": reviewContent,
                    "reviewRate": reviewRate
                },
                dataType: "json",
                success: function (list) {
                    commentList(list);
                    reload();
                },
                error: function () {
                    alert('리뷰 수정 실패');
                }
            });
        }
    }

    function reload() {
        history.go(0);
    }
</script>
</html>